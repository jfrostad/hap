---
title: "Changelog"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Function Updates}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```


# May 31st, 2019

* Stacking functions now have a full run function (`run_child_stackers`) which is what the parallel model scripts are pointed to now, instead of sourcing a script to run child stackers.

* `gam_stacker` is deprecated for good.

* Both `parallel_model.R` and `parallel_model_pkgtest.R` now has the new stacking functions. The `diff` that would be relevant for you to review would be [here](https://stash.ihme.washington.edu/projects/GEOSP/repos/lbd_core/commits/a555c0f3466c85e7587899e762551e979044442e#mbg_central/share_scripts/parallel_model.R) (319-332).

* There is also a small snippet of code I added in lines 557-572 in the script above to make sure that the number of OMP and MKL threads are properly parsed in before calling INLA. Speaking of:

## IMPORTANT NOTE on PARALLEL THREADING 
I would like to point out that by default, Singularity does not parse in environment variables without forcing things through, and therefore, in order to truly use parallelized fitting in INLA with OMP and MKL threading, you *must* pass in a list to the `singularity_opts` parameter in `make_qsub_share`, like such: `singularity_opts = list(SET_OMP_THREADS=number_of_fthread, SET_MKL_THREADS=number_of_fthread)`. Documentation for that is [here](http://sandbox-web.ihme.washington.edu/~sadatnfs/LBDCore/reference/make_qsub_share.html). The cluster will allocate MKL and OMP threads equivalent to the number of fthreads supplied in your job, and so you can have that added in to your `make_qsub_share` safely. Thereâ€™s currently a PR in works to pass the OMP and MKL threads to be equal to the number of cores requested by default. Once that is merged in, the parallelizing behavior will be as expected by default.



# May 20th, 2019

* Logit raking can be done in fractional raking now.

* The new PARDISO solver is now available for modelers to use. Large regions can use multiple threads now, and speedup has shown to be quite significant (a 3-day model can take as little as 8 hours to run). Usage is FREE but requires registration - see [here](https://pardiso-project.org/r-inla/). The two things you need to do are:
1. Get a license and add one line to your code: `inla.setOption("pardiso.license", "/path/to/your-license.lic")`.  
2. Make sure you're using the latest development Singularity images, located in `/share/singularity-images/lbd/testing_INLA_builds/`. You would need to set the `singularity` parameter in your qsub making functions to point to the full path of the image.

Some success stories have been recorded in history so far; week-long models are finishing in days/hours now, which is great.


# April 30th, 2019

* Fractional raking and aggregation is implemented as part of post-estimation. After pulling in the latest state of the develop branch, the only changes that needs to be made for run-time are a few config arguments (which has defaults set), and a few parts regarding the post-estimation part of your launch script.

* No changes are needed for parallel model script, only the post-estimation script. The generalized post-estimation script with fractional raking (which should be pointed to in your `make_qsub_postest` is located [here](https://stash.ihme.washington.edu/projects/GEOSP/repos/lbd_core/browse/mbg_central/share_scripts/postest_frax_script.R)

* All the necessary changes to move from legacy raking to fractional raking are documented [here](http://sandbox-web.ihme.washington.edu/~sadatnfs/LBDCore/articles/fractional_raking_migration.html). An example full run script (launch) using fractional raking is located [here](https://stash.ihme.washington.edu/projects/GEOSP/repos/lbd_core/browse/mbg_central/LBDCore/testing_models/launch_with_fractional_raking.R?).

* The config arguments needed to control raking are: `rake_countries`, `rake_subnational`, `countries_not_to_rake`, `countries_not_to_subnat_rake` and `metric_space`. Information on what they are (and default to) can be found [here](http://sandbox-web.ihme.washington.edu/~sadatnfs/LBDCore/articles/config_descriptions.html).



# Further past updates.

* All instances of `rasterize()` has been changed to use `rasterize_check_coverage()`, which uses the link table to assign locations to pixels. This will allow for capturing any pixels left behind on coastlines and between country borders.

* `rake_cell_pred` has implemented some fixes for when raking and master rasters don't line up.